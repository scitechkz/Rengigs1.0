<!DOCTYPE html>
<html lang="en" class="scroll-smooth transition-all duration-300">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOP Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
  <style>
    .chat-bubble {
      max-width: 75%;
      padding: 14px 20px;
      border-radius: 1.25rem;
      margin: 4px 0;
      word-wrap: break-word;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      animation: fadeIn 0.3s ease-in-out;
    }
    .user-message {
      background: linear-gradient(to right, #6366f1, #8b5cf6);
      color: white;
      align-self: flex-end;
    }
    .bot-message {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      color: #111827;
      align-self: flex-start;
    }
    .dark .bot-message {
      background: rgba(55, 65, 81, 0.6);
      color: #f9fafb;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .typing {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }

    .typing span {
      width: 6px;
      height: 6px;
      background-color: #888;
      border-radius: 50%;
      display: inline-block;
      animation: blink 1.4s infinite both;
    }

    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white transition-all duration-300 flex flex-col h-screen">

  <!-- Header -->
  <header class="p-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg flex justify-between items-center">
    <div class="flex items-center gap-2 text-2xl font-bold">
      <i class="fas fa-robot"></i> SOP Chatbot
    </div>
    <button id="theme-toggle" class="text-white hover:text-yellow-300 text-lg" title="Toggle Dark Mode">
      <i class="fas fa-moon"></i>
    </button>
  </header>

  <!-- Chat Container -->
  <div id="chatbox" class="flex-1 overflow-y-auto px-4 py-4 flex flex-col space-y-2 bg-white dark:bg-gray-800">
    <div class="flex gap-2 items-start">
      <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white text-sm">ü§ñ</div>
      <div class="chat-bubble bot-message">
        üëã Hi! How can I assist you with SOPs today?
      </div>
    </div>
  </div>

  <!-- Input Section -->
  <div class="sticky bottom-0 bg-white dark:bg-gray-900 p-4 shadow-[0_-2px_15px_rgba(0,0,0,0.07)] flex items-center gap-2">
    <button id="emoji-button" class="text-2xl hover:scale-110 transition"><i class="far fa-smile"></i></button>
    <input type="text" id="user-input" placeholder="Type your question..." required
           class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm bg-gray-50 dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-900 dark:text-white" />
    <button id="ask-button" title="Send" class="bg-purple-600 text-white p-2 rounded-xl hover:bg-purple-700 transition">
      <i class="fas fa-paper-plane"></i>
    </button>
    <button id="voice-button" title="Voice input" class="bg-blue-600 text-white p-2 rounded-xl hover:bg-blue-700 transition">
      <i class="fas fa-microphone"></i>
    </button>
  </div>

  <!-- Footer -->
  <footer class="text-center py-3 text-sm bg-transparent">
    <a href="{% url 'home' %}" class="text-indigo-600 hover:underline">‚Üê Back to Home</a>
  </footer>

  <!-- Script -->
  <script>
    let isVoiceInput = false;

    const chatbox = document.getElementById("chatbox");
    const inputField = document.getElementById("user-input");
    const askButton = document.getElementById("ask-button");
    const voiceButton = document.getElementById("voice-button");

    async function sendMessage(userInput) {
      if (!userInput) {
        alert("Please enter a question!");
        return;
      }

      // Add user message with avatar
      const userWrapper = document.createElement("div");
      userWrapper.className = "flex gap-2 items-start justify-end";

      const userBubble = document.createElement("div");
      userBubble.className = "chat-bubble user-message";
      userBubble.textContent = userInput;

      const userAvatar = document.createElement("div");
      userAvatar.className = "w-8 h-8 rounded-full bg-indigo-400 flex items-center justify-center text-white text-sm";
      userAvatar.textContent = "üë§";

      userWrapper.appendChild(userBubble);
      userWrapper.appendChild(userAvatar);
      chatbox.appendChild(userWrapper);
      scrollToBottom();

      inputField.value = "";

      // Add typing effect
      const typingWrapper = document.createElement("div");
      typingWrapper.className = "flex gap-2 items-start";
      typingWrapper.id = "typing-indicator";

      const botAvatar = document.createElement("div");
      botAvatar.className = "w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white text-sm";
      botAvatar.textContent = "ü§ñ";

      const typingBubble = document.createElement("div");
      typingBubble.className = "chat-bubble bot-message";
      typingBubble.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;

      typingWrapper.appendChild(botAvatar);
      typingWrapper.appendChild(typingBubble);
      chatbox.appendChild(typingWrapper);
      scrollToBottom();

      try {
        const response = await fetch("/api/chatbot/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userInput, is_voice: isVoiceInput })
        });

        const result = await response.json();
        document.getElementById("typing-indicator").remove();

        if (result.response) {
          const botWrapper = document.createElement("div");
          botWrapper.className = "flex gap-2 items-start";

          const botMessage = document.createElement("div");
          botMessage.className = "chat-bubble bot-message";
          botMessage.textContent = result.response;

          botWrapper.appendChild(botAvatar.cloneNode(true));
          botWrapper.appendChild(botMessage);
          chatbox.appendChild(botWrapper);

          if (isVoiceInput) speakResponse(result.response);
        } else {
          alert("Error: " + result.error);
        }
      } catch (error) {
        document.getElementById("typing-indicator").remove();
        alert("Error sending request. Check console for details.");
        console.error(error);
      }

      scrollToBottom();
    }

    askButton.addEventListener("click", () => {
      isVoiceInput = false;
      sendMessage(inputField.value.trim());
    });

    voiceButton.addEventListener("click", () => {
      let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.onresult = function (event) {
        const spokenText = event.results[0][0].transcript;
        inputField.value = spokenText;
        isVoiceInput = true;
        sendMessage(spokenText);
      };
      recognition.start();
    });

    function speakResponse(text) {
      let utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      window.speechSynthesis.speak(utterance);
    }

    function scrollToBottom() {
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Emoji Picker
    const picker = new EmojiButton();
    const trigger = document.querySelector('#emoji-button');
    picker.on('emoji', emoji => {
      inputField.value += emoji;
    });
    trigger.addEventListener('click', () => picker.togglePicker(trigger));

    // Dark Mode Toggle with persistence
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // Apply stored theme
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    }
  </script>
</body>
</html>
